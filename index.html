<!doctype html>

<title>MMT QuickEditor</title>
<meta charset="utf-8"/>

<!-- vvv update the version here if you update the ../exports/codemirror Git submodule -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.1/codemirror.min.css">
<link rel="stylesheet" href="codemirror/theme/dracula.css">
<link rel="stylesheet" href="codemirror/addon/hint/show-hint.css">

<!-- vvv update the version here if you update the ../exports/codemirror Git submodule -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.1/codemirror.min.js"></script>
<script src="codemirror/addon/hint/show-hint.js"></script>

<script src="codemirror/addon/mode/advanced.js"></script>
<script src="codemirror/mode/mmt/mmt.js"></script>

<article>
<h1>MMT QuickEditor</h1>
<form><textarea id="code">namespace http://example.com/mmt-demo ❚

import lfx http://gl.mathhub.info/MMT/LFX/TypedHierarchy ❚
import finite http://gl.mathhub.info/MMT/LFX/Finite ❚
import rules scala://structuralfeatures.lf.mmt.kwarc.info❚

theory Notations =
	Pi      # { V1T,… } 2 prec -10000❙
	lambda  # [ V1T,… ] 2 prec -10000❙
	apply   # 1%w…        prec -10❙
	arrow   # 1⟶…        prec  -9990❙
	case    # [ V2T,… ] 1 ⇝ 3 prec 5❙
❚

// Views ❚
view emptyView : ?S -> ?T = ❚

view v : ?S -> ?T =
	a = b ❙
	c = d ❙
❚</textarea></form>

<p>Type "j" and press <strong>ctrl-space</strong> to activate autocompletion for Unicode characters.</p>

<h1>Abbreviation Search (forward & reverse lookup)</h1>

Enter any (substring) of an abbreviation or Unicode character: <input type="text" id="abbrSearch" /><br>
<ul id="abbrLookupResults"></ul>

<script src="abbreviations.js"></script>
<script>
const abbreviations = loadAbbreviations();

const abbrSearch = document.getElementById("abbrSearch");
const abbrLookupResults = document.getElementById("abbrLookupResults");

abbrSearch.addEventListener("input", updateAbbreviationLookupResults.bind(null));
updateAbbreviationLookupResults();

function updateAbbreviationLookupResults() {
	// clear all previous lookup results
	//
	// might be pretty slow, see also
	// https://stackoverflow.com/questions/3955229/remove-all-child-elements-of-a-dom-node-in-javascript
	abbrLookupResults.innerHTML = "";


	for (const [abbrKey, abbrValue] of fuzzyFindAbbreviations(abbrSearch.value)) {
		const result = document.createElement("li");
		result.appendChild(document.createTextNode(`${abbrKey}\t${abbrValue}`));
		abbrLookupResults.appendChild(result);
	}
}

function fuzzyFindAbbreviations(str) {
	str = str.toLowerCase();

	const matches = [];

	for (const [abbrKey, abbrValue] of abbreviations.entries()) {
		if (abbrKey.toLowerCase().includes(str) || abbrValue.toLowerCase().includes(str)) {
			matches.push([abbrKey, abbrValue]);
		}
	}

	return matches;
}
</script>

<script>
const Pos = CodeMirror.Pos;

function findMatchingAbbreviations(str, cursorLine, tokenEndCh) {
	console.log(str);
	str = str.toLowerCase();

	const matches = [];

	for (const [abbrKey, abbrValue] of abbreviations.entries()) {
		const caseInsensitiveAbbrKey = abbrKey.toLowerCase();

		for (let i = 0; i < abbrKey.length; i++) {
			if (str.endsWith(caseInsensitiveAbbrKey.slice(0, i + 1))) {
				matches.push({
					text: abbrValue,
					displayText: `${abbrValue}\t\t${abbrKey}`,
					from: Pos(cursorLine, tokenEndCh - (i + 1)),
					to: Pos(cursorLine, tokenEndCh)
				});
			}
		}
	}

	return matches;
}

CodeMirror.registerHelper("hint", "mmt", function(editor, options) {
	// Find the token at the cursor
	var cur = editor.getCursor();
	console.log(cur);
	var token = editor.getTokenAt(cur);

	const matchingAbbreviations = findMatchingAbbreviations(token.string, cur.line, token.end);
	return {
		list: matchingAbbreviations,
		from: Pos(cur.line, token.start),
		to: Pos(cur.line, token.end)
	};
});


const editor = CodeMirror.fromTextArea(document.getElementById("code"), {
	mode: "mmt",
	lineNumbers: true,
	extraKeys: {"Ctrl-Space": "autocomplete"}
});
editor.setOption("theme", "dracula");


</script>

</article>

</body>
</html>